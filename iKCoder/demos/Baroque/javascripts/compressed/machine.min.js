var WHEEL_RADIUS=172;var WHEEL_RADIUS_SQUARED=Math.pow(WHEEL_RADIUS,2);var WHEEL_CIRCUMFERENCE=Math.PI*WHEEL_RADIUS_SQUARED;var WHEEL_QUARTER_SEG=Math.sqrt(2*WHEEL_RADIUS_SQUARED);var NUBS=4;var THREAD_LOADER=0;var TIME_BETWEEN_LOAD=0.25;var LOAD_TIME_OVERALL=12.5;var CLEAR_RECT_MARG=50;var HEIGHT_ALL_THREADS=WHEEL_QUARTER_SEG;var FPS_BACKGROUND=2;var Machine=function(a){this.cv=a;this.isMouseMoving=false;this.arrThreads=new Array();this.arrLength=new Array();this.arrNubs=new Array(4);this.arrPitchStart=new Array(TOTAL_THREADS);this.isMouseDown=false;this.rSpd=0;this.rSpdAvg=0;this.fAvg=5;this.setTempo(BPM_NORM);this.rSpdGrab=0.4;this.xp0;this.yp0;this.xp1;this.yp1;this.pt0=new Point();this.pt1=new Point();this.isFirstRun=true;this.wasResized=false;this.isHoldingNub=false;this.nubOver=null;this.indGroup=0;this.ctGrab=0;this.pluckMax=2;this.indThreadLoader=0;this.isIntro=true;this.isIntroDone=false;this.noteSongRdPrev=0;this.threadsInPlace=false;this.isInBackground=false;this.xbLimitMin=-MAX_LENGTH*0.5;this.xbLimitMax=MAX_LENGTH*0.5;this.ybLimitMin=-HEIGHT_ALL_THREADS*0.5;this.ybLimitMax=HEIGHT_ALL_THREADS*0.5;this.xbMin=this.xbLimitMin;this.xbMax=this.xbLimitMax;this.ybMin=this.ybLimitMin;this.ybMax=this.ybLimitMax;this.init()};Machine.prototype.init=function(){this.elmAbout=document.getElementById("about");this.elmLoader=document.getElementById("loader");this.elmAbout.innerHTML='<a href="'+aboutURL+'" target="_blank">&nbsp;&nbsp;?&nbsp;</a>';runGoogleAnalytics()};Machine.prototype.build=function(){this.setOrigin();var f=MAX_LENGTH;for(var e=0;e<TOTAL_NOTES;e++){this.arrLength[e]=f;f*=HALF_STEP_MULTIPLIER}var g,h,d,c;var j=WHEEL_QUARTER_SEG/TOTAL_THREADS;var a=(TOTAL_THREADS/2)*j-0.5*j;for(var e=0;e<TOTAL_THREADS;e++){this.arrPitchStart[e]=suite.arrMidiMap[SONG_DATA_ARRAY[e]];d="#FFFFFF";h=3;var c=-1;var b=new Thread(a,c,h,d,e,this.cv);a-=j;this.arrThreads.push(b)}this.wheel0=new Wheel(WHEEL_RADIUS,0,0,this.cv);this.wheel1=new Wheel(-WHEEL_RADIUS,0,1,this.cv);this.arrNubs[0]=this.wheel0.nub0=new Nub(0,0,suite.machine,this.wheel0,this.cv);this.arrNubs[1]=this.wheel0.nub1=new Nub(1,1,suite.machine,this.wheel0,this.cv);this.arrNubs[2]=this.wheel1.nub0=new Nub(0,2,suite.machine,this.wheel1,this.cv);this.arrNubs[3]=this.wheel1.nub1=new Nub(1,3,suite.machine,this.wheel1,this.cv);this.cv.globalCompositeOperation="lighter";this.arrNubs[0].enter()};Machine.prototype.beginLoading=function(){this.tFrame0=this.tSong0=this.tNotes0=this.tLoadPrev=this.tLoading0=this.t0=(new Date()).getTime()/1000;this.ctFrame=0;this.xp0=this.getUserX();this.yp0=this.getUserY()};Machine.prototype.exitLoading=function(){this.isIntro=false;for(var a=0;a<this.arrNubs.length;a++){this.arrNubs[a].exitLoader()}this.updThreads()};Machine.prototype.mouseDown=function(){this.isMouseDown=true};Machine.prototype.mouseUp=function(){this.isMouseDown=false};Machine.prototype.setGroup=function(c){this.indGroup=c;for(var a=0;a<this.arrThreads.length;a++){var b=SONG_DATA_ARRAY[this.indGroup+a];if(b==-1){pitch=-1}else{pitch=suite.arrMidiMap[b]}this.arrThreads[a].setTargetPitch(pitch)}};Machine.prototype.setTempo=function(a){this.bpm=a;this.bps=a/60};Machine.prototype.getUserX=function(){return mouseX-this.xo};Machine.prototype.getUserY=function(){return mouseY-this.yo};Machine.prototype.xAsRatio=function(a){a=lim(a,0,this.width);return a/this.width};Machine.prototype.upd=function(){this.xbMin=this.xbLimitMin;this.xbMax=this.xbLimitMax;this.ybMin=this.ybLimitMin;this.ybMax=this.ybLimitMax;if(SHOW_FRAMERATE){this.updFramerate()}if(this.isIntro){this.updLoading()}if(this.isIntro){this.updTime()}else{this.updTime()}this.updPos();if(!this.isMouseDown){this.updMouseUp()}if(this.wasResized){this.wasResized=false;this.cv.globalCompositeOperation="lighter"}this.updWheels();this.cv.clearRect(this.xo+this.xbMin-CLEAR_RECT_MARG,this.yo+this.ybMin-CLEAR_RECT_MARG,this.xbMax-this.xbMin+CLEAR_RECT_MARG*2,this.ybMax-this.ybMin+CLEAR_RECT_MARG*2);this.updateAndRedrawThreads();this.redrawNubs()};Machine.prototype.updTime=function(){this.t1=(new Date()).getTime()/1000;this.elapFrame=this.t1-this.t0;this.t0=this.t1;var d=1/this.elapFrame;if(d<=FPS_BACKGROUND){if(!this.isInBackground){this.switchBackgroundMode(1);this.isInBackground=true}}else{if(this.isInBackground){this.switchBackgroundMode(0);this.isInBackground=false}}this.elapSong=this.t1-this.tSong0;this.beatSong=this.bps*this.elapSong;this.noteSong=this.beatSong*NOTE_UNIT;this.noteSongRd=Math.floor(this.noteSong);if(this.isIntro){if(this.noteSongRd!=this.noteSongRdPrev){if(this.isIntroDone){if((this.noteSongRdPrev<this.nextNoteBreak)&&(this.noteSongRd>=this.nextNoteBreak)){var a=this.beatSong%1;var b=a/this.bps;this.tSong0=this.tNotes0=this.t1-b;this.exitLoading()}}this.noteSongRdPrev=this.noteSongRd}}else{if(this.noteSong>this.indGroup+TOTAL_THREADS){this.tNotes0=this.t1;var c=this.indGroup+TOTAL_THREADS;if(c>=TOTAL_NOTES_IN_SONG){c=0;this.tSong0=this.t1}this.setGroup(c)}}this.nextNoteBreak=this.noteSongRd+(32-(this.noteSongRd%32))};Machine.prototype.updWheels=function(){var a;this.wheel0.setRot((MATH_PI*(0.25+(this.beatSong%16)/16*2))%(2*MATH_PI));this.wheel1.setRot((MATH_PI*(0.25-(this.beatSong%16)/16*2))%(2*MATH_PI));this.wheel0.upd();this.wheel1.upd()};Machine.prototype.switchBackgroundMode=function(b){switch(b){case 1:break;case 0:for(var a=0;a<4;a++){this.arrNubs[a].returnFromBackground()}break;default:break}};Machine.prototype.redrawNubs=function(){this.wheel0.nub0.redraw();this.wheel0.nub1.redraw();this.wheel1.nub0.redraw();this.wheel1.nub1.redraw()};Machine.prototype.updThreads=function(){for(var a=0;a<this.arrThreads.length;a++){this.arrThreads[a].upd()}};Machine.prototype.redrawThreads=function(){for(var a=0;a<this.arrThreads.length;a++){this.arrThreads[a].redraw()}};Machine.prototype.updateAndRedrawThreads=function(){for(var a=0;a<this.arrThreads.length;a++){this.arrThreads[a].upd();this.arrThreads[a].redraw()}};Machine.prototype.updLoading=function(){var c;if(!suite.soundReady){var a=Math.round(suite.indNoteLd/TOTAL_NOTES*100);c="Loading sound ("+a+"%)";if(SHOW_FRAMERATE){this.elmLoader.innerHTML+='<span class="loading">'+c+"</span>"}else{this.elmLoader.innerHTML='<span class="loading">'+c+"</span>"}}this.tLoadCurr=(new Date).getTime()/1000;var b=this.tLoadCurr-this.tLoadPrev;this.rLoad=(this.tLoadCurr-this.tLoading0)/LOAD_TIME_OVERALL;if(this.rLoad>=1){this.rLoad=1}if(b>TIME_BETWEEN_LOAD){this.tLoadPrev=this.tLoadCurr;this.incrLoad()}};Machine.prototype.updFramerate=function(){this.tFrame1=(new Date).getTime()/1000;var a=this.tFrame1-this.tFrame0;this.tFrame0=this.tFrame1;this.ctFrame++;if(this.ctFrame%5==0){this.numFrame=Math.round(100/a)/100}this.elmLoader.innerHTML='<span class="loading">'+this.numFrame+"</span> &nbsp; "};Machine.prototype.incrLoad=function(){var l;if(this.rLoad>0.15){l=this.arrNubs[2];if(!l.hasEntered){l.enter()}l=this.arrNubs[0];if(!l.hasEntered){l.enter()}}if(this.rLoad>0.85){l=this.arrNubs[1];if(!l.hasEntered){l.enter()}}if(this.rLoad>0.97){l=this.arrNubs[3];if(!l.hasEntered){l.enter()}}var j=0.4;var h=0.8;var e;if(this.rLoad<j){e=0}else{e=(this.rLoad-j)/(h-j);if(e>1){e=1}}var k=e*TOTAL_THREADS;var d=Math.floor((Math.random()*0.999)*k);var a,m,b;var f=0;for(var g=0;g<TOTAL_THREADS;g++){if(g>k){break}a=this.arrPitchStart[d];b=this.arrThreads[d];if(b.pitchInd==a){d=(d+1)%TOTAL_THREADS;f++}else{var c;if(k==0){c=1}else{c=1+Math.round(Math.random()*2)}off=Math.floor(lerp(-3,0,this.rLoad));m=b.pitchInd+c+off;if(m<0){m=0}if(m>a){m=a}if((suite.indNoteLd>0)&&(suite.indNoteLd-1>=m)){b.setTargetPitch(m);break}}}if((f==TOTAL_THREADS)&&!this.threadsInPlace){this.threadsInPlace=true}if(this.threadsInPlace&&suite.soundReady&&this.rLoad>=1&&!this.isIntroDone){console.log("isIntroDone true!");this.isIntroDone=true}};Machine.prototype.checkMoving=function(){var b=0;for(var a=0;a<this.arrThreads.length;a++){if(this.arrThreads[a].isOsc){b++}}};Machine.prototype.getSpd=function(){return this.rSpd};Machine.prototype.getSpdAvg=function(){return this.rSpdAvg};Machine.prototype.updPos=function(){this.xp1=this.getUserX();this.yp1=this.getUserY();this.pt0.x=this.xp0;this.pt0.y=this.yp0;this.pt1.x=this.xp1;this.pt1.y=this.yp1;this.dx=this.xp1-this.xp0;this.dy=this.yp1-this.yp0;this.dist=Math.sqrt(this.dx*this.dx+this.dy*this.dy);this.isMouseMoving=(this.dist>0.2);this.spd=this.dist/this.elapFrame;this.rSpd=lim((this.spd-MOUSE_SPEED_MIN)/(MOUSE_SPEED_MAX-MOUSE_SPEED_MIN),0,1);this.rSpdAvg=(this.rSpdAvg*(this.fAvg-1)/this.fAvg)+(this.rSpd*(1/this.fAvg));this.xp0=this.xp1;this.yp0=this.yp1};Machine.prototype.updMouseUp=function(){if((this.nubOver!=null)&&(!this.isHoldingNub)){if(this.nubOver.checkMouseOver()){return}else{this.nubOver.rollOut();this.nubOver=null}}for(var a=0;a<4;a++){if(this.arrNubs[a].checkMouseOver()){this.nubOver=this.arrNubs[a];this.nubOver.rollOver();break}}};Machine.prototype.mouseDown=function(){this.isMouseDown=true;if(this.nubOver!=null){this.nubOver.grab();this.isHoldingNub=true}};Machine.prototype.mouseUp=function(){this.isMouseDown=false;if(this.isHoldingNub){this.nubOver.drop();this.isHoldingNub=false}};Machine.prototype.dropAll=function(){for(var a=0;a<this.arrThreads.length;a++){if(this.arrThreads[a].isGrabbed){this.arrThreads[a].drop()}}};Machine.prototype.doneLoading=function(){if(!SHOW_FRAMERATE){this.elmLoader.style.display="none"}};Machine.prototype.checkBoxLimit=function(a,b){if(a<this.xbMin){this.xbMin=a}else{if(a>this.xbMax){this.xbMax=a}}if(b<this.ybMin){this.ybMin=b}else{if(b>this.ybMax){this.ybMax=b}}};Machine.prototype.rsize=function(){this.wasResized=true;this.width=suite.canvasEl.width=window.innerWidth;this.height=suite.canvasEl.height=window.innerHeight;this.elmLoader.style.left="20px";this.elmLoader.style.top=(this.height-28)+"px";this.elmAbout.style.left=(this.width-35)+"px";this.elmAbout.style.top=(this.height-32)+"px";this.setOrigin()};Machine.prototype.setOrigin=function(){this.xo=Math.round(this.width/2);this.yo=Math.round(this.height/2)};