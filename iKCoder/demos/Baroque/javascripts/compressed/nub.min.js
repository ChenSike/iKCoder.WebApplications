var RAD_NORM=6;var RAD_OVER=15;var RAD_GRAB=10;var RAD_EASE=0.4;var EASE_ORBIT_GRAB=0.2;var EASE_ORBIT_FOLLOW=0.02;var EASE_ORBIT_RESTORE=0.02;var EASE_CENTER_GRAB=0.3;var EASE_CENTER_RESTORE=0.015;var EASE_CENTER_FOLLOW_MIN=0.04;var EASE_CENTER_FOLLOW_MAX=0.01;var EASE_ORBIT_LOADER=0.003;var EASE_CENTER_LOADER=0.03;var EASE_ORBIT_EXIT_LOADER=0.1;var EASE_CENTER_EXIT_LOADER=0.1;var TRAIL_OPAC_MIN=0.04;var TRAIL_OPAC_MAX=0.5;var TRAIL_FADEOUT=0.6;var TRAIL_PTS=24;var TRAIL_SAMPLE=4;var ROLLOVER_RAD_SQ=3500;var PLUCK_FRAME_MAX=2;var ORBIT_FOLLOW_MIN=WHEEL_RADIUS*0.3;var ORBIT_FOLLOW_MAX=WHEEL_RADIUS*0.5;var ORBIT_LOADER=35;var ORBIT_GRAB=15;var THROW_SPD_MAX=23;var THROW_SPD_MIN=6;var Nub=function(d,b,c,a,e){this.xp0;this.yp0;this.xp1;this.yp1;this.xpw;this.ypw;this.pt0=new Point();this.pt1=new Point();this.wheel=a;this.machine=c;this.ind=d;this.indAll=b;this.cv=e;this.xpOrbit=this.xpOrbitTarg=this.wheel.xp;this.ypOrbit=this.ypOrbitTarg=this.wheel.yp;this.orbit=this.orbitTarg=WHEEL_RADIUS;this.rad=RAD_NORM;this.radTarg=RAD_NORM;this.scaleRat=0;this.velX=0;this.velY=0;this.dampVel=0.93;this.arrTrail=new Array(TRAIL_PTS);this.frameCt=this.indAll;this.spd=0;this.isMouseOver=false;this.isGrabbed=false;this.isFollowing=false;this.isFirstRun=true;this.hasEntered=false;this.isLoading=false;this.isTossing=false;this.init()};Nub.prototype.init=function(){this.m=this.machine};Nub.prototype.upd=function(){if(!this.hasEntered){return}this.updPos();this.updInteract()};Nub.prototype.updInteract=function(){if(this.isFirstRun){this.isFirstRun=false;return}if(this.spd>SPD_IGNORE_MAX){return}var a;var c;var d;var f=0;for(var b=0;b<this.m.arrThreads.length;b++){d=this.m.arrThreads[b];var e=lineIntersect(this.pt0,this.pt1,d.pt0,d.pt1);if(e==null){continue}a=e.x;c=e.y;if((!d.isGrabbed)&&(!isNaN(a))&&(!isNaN(c))){if(this.spd>SPD_GRAB){d.pluck(a,c,true,this);f++;if(f>PLUCK_FRAME_MAX){break}}else{d.grab(a,c,true,this);break}}}};Nub.prototype.updPos=function(){var f=new Date();this.t1=f.getTime()/1000;var c=this.t1-this.t0;this.t0=this.t1;this.velX*=this.dampVel;this.velY*=this.dampVel;if(Math.abs(this.velX)<0.5){this.velX=0}if(Math.abs(this.velY)<0.5){this.velY=0}this.xpv=this.xp0+this.velX;this.ypv=this.yp0+this.velY;if(this.rad!=this.radTarg){var e=(this.radTarg-this.rad);if(Math.abs(e)<1){this.rad=this.radTarg}else{this.rad+=e*RAD_EASE}}if(Math.abs(this.velX)>0||Math.abs(this.velY)>0){this.isTossing=true}else{this.isTossing=false}if(this.isTossing){this.setPos(this.xpv,this.ypv);this.xpOrbit=this.xpv;this.ypOrbit=this.ypv;this.orbit=0}else{if(this.machine.isHoldingNub){this.xpOrbitTarg=this.machine.getUserX();this.ypOrbitTarg=this.machine.getUserY()}else{if(this.isMouseOver){this.xpOrbitTarg=this.machine.getUserX();this.ypOrbitTarg=this.machine.getUserY()}else{if(!this.isLoading){this.xpOrbitTarg=this.wheel.xp;this.ypOrbitTarg=this.wheel.yp}else{this.xpOrbitTarg=this.wheel.xp;this.ypOrbitTarg=this.wheel.yp}}}var b=this.isMouseOver?0:this.orbitTarg;if(this.orbit!=b){this.orbit+=(b-this.orbit)*this.easeOrbit;if(Math.abs(this.orbitTarg-this.orbit)<1){this.orbit=this.orbitTarg}}if(this.xpOrbit!=this.xpOrbitTarg){this.xpOrbit+=(this.xpOrbitTarg-this.xpOrbit)*this.easeCenter;if(Math.abs(this.xpOrbitTarg-this.xpOrbit)<1){this.xpOrbit=this.xpOrbitTarg}}if(this.ypOrbit!=this.ypOrbitTarg){this.ypOrbit+=(this.ypOrbitTarg-this.ypOrbit)*this.easeCenter;if(Math.abs(this.ypOrbitTarg-this.ypOrbit)<1){this.ypOrbit=this.ypOrbitTarg}}if(this.ind==0){this.xpw=this.xpOrbit+this.wheel.cosAng*this.orbit;this.ypw=this.ypOrbit+this.wheel.sinAng*this.orbit}else{this.xpw=this.xpOrbit-this.wheel.cosAng*this.orbit;this.ypw=this.ypOrbit-this.wheel.sinAng*this.orbit}if(this.isFirstRun){this.xp0=this.xp1=this.xpw;this.yp0=this.yp1=this.ypw;for(var a=0;a<TRAIL_PTS;a++){this.arrTrail[a]=new Point(this.xpw,this.ypw)}}this.setPos(this.xpw,this.ypw)}this.dx=this.xp1-this.xp0;this.dy=this.yp1-this.yp0;this.pt0.x=this.xp0;this.pt0.y=this.yp0;this.pt1.x=this.xp1;this.pt1.y=this.yp1;this.xp0=this.xp1;this.yp0=this.yp1;this.dist=Math.sqrt(this.dx*this.dx+this.dy*this.dy);this.spd=this.dist;if(this.frameCt%TRAIL_SAMPLE==0){this.arrTrail.shift();this.arrTrail[TRAIL_PTS-1]=new Point(this.xp0,this.yp0)}for(var a=0;a<this.arrTrail.length;a++){this.m.checkBoxLimit(this.arrTrail[a].x,this.arrTrail[a].y)}this.frameCt++};Nub.prototype.enter=function(){this.hasEntered=true;this.isLoading=true;if(this.indAll==0){this.xpOrbit=-150;this.ypOrbit=this.m.height*0.6;this.orbit=ORBIT_LOADER*0.3}else{if(this.indAll==1){this.xpOrbit=this.m.width*1;this.ypOrbit=-this.m.height*0.9;this.orbit=ORBIT_LOADER*5.5}else{if(this.indAll==2){this.xpOrbit=-this.m.width*1.5;this.ypOrbit=this.m.height*1;this.orbit=ORBIT_LOADER*6}else{if(this.indAll==3){this.xpOrbit=this.m.width*1.2;this.ypOrbit=-this.m.height*0.8;this.orbit=ORBIT_LOADER*1.5}}}}this.radTarg=RAD_NORM;this.orbitTarg=WHEEL_RADIUS;this.easeOrbit=EASE_ORBIT_LOADER;this.easeCenter=EASE_CENTER_LOADER;this.radTarg=RAD_NORM};Nub.prototype.exitLoader=function(){this.isLoading=false;this.orbitTarg=WHEEL_RADIUS;this.easeOrbit=EASE_ORBIT_EXIT_LOADER;this.easeCenter=EASE_CENTER_EXIT_LOADER;this.radTarg=RAD_NORM};Nub.prototype.rollOver=function(){this.isMouseOver=true;this.radTarg=RAD_OVER};Nub.prototype.rollOut=function(){this.isMouseOver=false;this.radTarg=RAD_NORM};Nub.prototype.grab=function(){this.velX=this.velY=0;this.easeOrbit=EASE_ORBIT_GRAB;this.easeCenter=EASE_CENTER_GRAB;this.isGrabbed=true;this.radTarg=RAD_GRAB;this.orbitTarg=ORBIT_GRAB;var b=Math.floor(Math.random()*NUBS);if(b==NUBS){b=NUBS-1}for(var a=0;a<NUBS;a++){var c=this.machine.arrNubs[b];if(c!=this){c.follow(a)}b=(b+1)%NUBS}};Nub.prototype.drop=function(){this.isGrabbed=false;this.orbitTarg=WHEEL_RADIUS;this.easeOrbit=EASE_ORBIT_RESTORE;this.easeCenter=EASE_CENTER_RESTORE;this.radTarg=RAD_NORM;this.velX=this.m.dx;this.velY=this.m.dy;var a=Math.abs(this.velX);var b=Math.abs(this.velY);if(a>THROW_SPD_MAX){this.velX=a/this.velX*THROW_SPD_MAX}else{if(a<THROW_SPD_MIN){if(this.dx==0){this.velX=(Math.random()>0.5?-1:1)*THROW_SPD_MIN}else{this.velX=Math.abs(this.dx)/this.dx*THROW_SPD_MIN}}}if(b>THROW_SPD_MAX){this.velY=b/this.velY*THROW_SPD_MAX}else{if(b<THROW_SPD_MIN){if(this.dy==0){this.velY=(Math.random()>0.5?-1:1)*THROW_SPD_MIN}else{this.velY=Math.abs(this.dy)/this.dy*THROW_SPD_MIN}}}var f=Math.sqrt(a*a+b*b);var e=1;var c;for(var d=0;d<NUBS;d++){c=this.machine.arrNubs[d];if(c!=this&&c.hasEntered){c.unfollow(this,this.velX,this.velY,e/NUBS)}e++}};Nub.prototype.follow=function(a){var b=a/(NUBS-1);this.orbitTarg=lerp(ORBIT_FOLLOW_MIN,ORBIT_FOLLOW_MAX,b);this.easeCenterFollow=lerp(EASE_CENTER_FOLLOW_MIN,EASE_CENTER_FOLLOW_MAX,b);this.easeOrbit=EASE_ORBIT_FOLLOW;this.easeCenter=this.easeCenterFollow};Nub.prototype.unfollow=function(g,e,d,a){var c=g.xp1-this.xp1;var b=g.yp1-this.yp1;var f=0.05;this.velX=(c*f+e*(1-f))*a;this.velY=(b*f+d*(1-f))*a;this.orbitTarg=WHEEL_RADIUS;this.easeOrbit=EASE_ORBIT_RESTORE;this.easeCenter=EASE_CENTER_RESTORE};Nub.prototype.checkMouseOver=function(){var b=this.machine.getUserX()-this.xp1;var a=this.machine.getUserY()-this.yp1;var c=b*b+a*a;return(c<ROLLOVER_RAD_SQ)};Nub.prototype.returnFromBackground=function(){for(var a=0;a<TRAIL_PTS;a++){this.arrTrail[a]=new Point(this.xp0,this.yp0)}};Nub.prototype.redraw=function(){if(!this.hasEntered){return}this.cv.beginPath();this.cv.fillStyle="#FFFFFF";this.cv.arc(this.xp1+this.m.xo,this.yp1+this.m.yo,this.rad,0,2*MATH_PI);this.cv.fill();this.cv.closePath();var d,m,c,k,b,h,l,a,j,o,e,n;if(this.machine.isInBackground){return}d=this.arrTrail[0].x;m=this.arrTrail[0].y;c=this.arrTrail[1].x;k=this.arrTrail[1].y;var g=TRAIL_PTS-2;for(var f=1;f<g;f++){n=(f-1)/(g-2);b=this.arrTrail[f].x;h=this.arrTrail[f].y;l=d+(c-d)*0.5;a=m+(k-m)*0.5;if(f==1){continue}j=c+(b-c)*0.5;o=k+(h-k)*0.5;this.cv.beginPath();this.cv.lineWidth=1;if(n<TRAIL_FADEOUT){e=lerp(TRAIL_OPAC_MIN,TRAIL_OPAC_MAX,n/TRAIL_FADEOUT)}else{e=lerp(TRAIL_OPAC_MAX,TRAIL_OPAC_MIN,(n-TRAIL_FADEOUT)/(1-TRAIL_FADEOUT))}this.cv.strokeStyle="rgba(255,255,255,"+e+")";this.cv.moveTo(this.m.xo+l,this.m.yo+a);this.cv.quadraticCurveTo(this.m.xo+c,this.m.yo+k,this.m.xo+j,this.m.yo+o);d=c;m=k;c=b;k=h;this.cv.stroke();this.cv.closePath()}};Nub.prototype.setPos=function(a,b){this.xp1=a;this.yp1=b};